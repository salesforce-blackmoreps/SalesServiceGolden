name: Deploy to client ORG environment From Apex

# CHANGE 1: Switch from workflow_dispatch to repository_dispatch
# This allows the Apex Class to trigger it.
on: 
  repository_dispatch:
    types: [deploy_trigger]

jobs:
  Deploy:
      runs-on: ubuntu-latest
      environment: sffnoobs
      steps:
          - uses: actions/setup-node@v3
            with:
              node-version: '18'

          - name: 'Checkout source code'
            uses: actions/checkout@v3
            with:
              # CHANGE 2: Use the branch sent from Salesforce Apex
              ref: ${{ github.event.client_payload.branch || 'main' }}
              fetch-depth: '0' 
                
          - name: 'Install sfdx'
            run: npm install @salesforce/cli --global

          # REMOVED: sfdx-git-delta steps. 
          # Reason: For an "Intake" button, you want to deploy the WHOLE app, 
          # not just the lines of code changed in the last 5 minutes.

          - name: 'Deploy to environment with running all local tests'
            run: |
                # Create the key file from the secret
                echo "${{ secrets.SERVER_KEY }}" > server.key
                
                # Login
                sf org login jwt --username ${{ vars.USER_NAME }} --jwt-key-file server.key --client-id ${{ vars.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
                
                # CHANGE 3: Deploy EVERYTHING in force-app
                # Added --wait 30 to prevent timeouts on large deploys
                sf project deploy start --source-dir force-app --wait 30